{% extends "base.html" %}

{% block title %}Roles de Juegos - {{ guild.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard.dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard.server_config', guild_id=guild.id) }}">{{ guild.name }}</a></li>
            <li class="breadcrumb-item active">Roles de Juegos</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-controller"></i> Configurar Roles de Juegos</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="gameRolesChannel" class="form-label">
                            <i class="bi bi-hash"></i> Canal para Panel de Roles
                        </label>
                        <select class="form-select" id="gameRolesChannel">
                            <option value="">Selecciona un canal...</option>
                            {% for channel in channels %}
                            <option value="{{ channel.id }}" 
                                    {% if game_roles_config and game_roles_config.channel_id == channel.id|string %}selected{% endif %}>
                                #{{ channel.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            Canal donde se enviar√° el panel de selecci√≥n de roles
                        </div>
                    </div>

                    <h6 class="mt-4 mb-3">Roles Configurados</h6>
                    <div id="gameRolesList">
                        {% if game_roles_config and game_roles_config.roles %}
                            {% for game_name, role_id in game_roles_config.roles.items() %}
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                                <div>
                                    <strong>{{ game_name }}</strong>
                                    <span class="text-muted">‚Üí</span>
                                    {% for role in roles %}
                                        {% if role.id|string == role_id %}
                                            <span class="badge" style="background-color: #{{ '%06x' % role.color }}">{{ role.name }}</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <button class="btn btn-sm btn-danger" onclick="removeGameRole('{{ game_name }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No hay roles configurados a√∫n</p>
                        {% endif %}
                    </div>

                    <h6 class="mt-4 mb-3">Agregar Nuevo Rol</h6>
                    <form id="addGameRoleForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="gameName" class="form-label">Nombre del Juego</label>
                                <select class="form-select" id="gameName" required>
                                    <option value="">Selecciona un juego...</option>
                                    <option value="Rexys">üéÆ Rexys</option>
                                    <option value="Lolsito">üéØ Lolsito</option>
                                    <option value="Pokemon">‚ö° Pokemon</option>
                                    <option value="Valorant">üî´ Valorant</option>
                                    <option value="Fortnite">üèóÔ∏è Fortnite</option>
                                    <option value="Marvel Rivals">‚öîÔ∏è Marvel Rivals</option>
                                    <option value="Battlefield">üí£ Battlefield</option>
                                    <option value="Palia">üåø Palia</option>
                                    <option value="League of Legends">üèÜ League of Legends</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="gameRole" class="form-label">Rol</label>
                                <select class="form-select" id="gameRole" required>
                                    <option value="">Selecciona un rol...</option>
                                    {% for role in roles %}
                                    <option value="{{ role.id }}">{{ role.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-plus-circle"></i> Agregar Rol
                        </button>
                    </form>

                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-primary" onclick="createGameRolesPanel()">
                            <i class="bi bi-send"></i> Crear/Actualizar Panel en Discord
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> ¬øC√≥mo funciona?</h6>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li class="mb-2">Configura los roles para cada juego</li>
                        <li class="mb-2">Selecciona un canal para el panel</li>
                        <li class="mb-2">Crea el panel en Discord</li>
                        <li class="mb-0">Los usuarios podr√°n seleccionar sus roles con botones</li>
                    </ol>
                </div>
            </div>

            <div class="card shadow-sm mb-3">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="bi bi-check-circle"></i> Caracter√≠sticas</h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li class="mb-2">Botones permanentes (funcionan 24/7)</li>
                        <li class="mb-2">Click para agregar, click de nuevo para remover</li>
                        <li class="mb-2">Dise√±o colorido y atractivo</li>
                        <li class="mb-0">F√°cil de usar para los miembros</li>
                    </ul>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Consejos</h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li class="mb-2">Crea roles espec√≠ficos para cada juego</li>
                        <li class="mb-2">Usa colores diferentes para cada rol</li>
                        <li class="mb-2">Coloca el panel en un canal visible</li>
                        <li class="mb-0">Actualiza el panel cuando agregues nuevos juegos</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('addGameRoleForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const gameName = document.getElementById('gameName').value;
    const roleId = document.getElementById('gameRole').value;
    
    try {
        const response = await fetch(`/api/guilds/{{ guild.id }}/game-roles`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ game_name: gameName, role_id: roleId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', 'Rol agregado correctamente');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('danger', 'Error al agregar: ' + result.error);
        }
    } catch (error) {
        showAlert('danger', 'Error de conexi√≥n');
    }
});

async function removeGameRole(gameName) {
    if (!confirm(`¬øEliminar el rol de ${gameName}?`)) return;
    
    try {
        const response = await fetch(`/api/guilds/{{ guild.id }}/game-roles/${gameName}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', 'Rol eliminado correctamente');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('danger', 'Error al eliminar: ' + result.error);
        }
    } catch (error) {
        showAlert('danger', 'Error de conexi√≥n');
    }
}

async function createGameRolesPanel() {
    const channelId = document.getElementById('gameRolesChannel').value;
    
    if (!channelId) {
        showAlert('warning', 'Por favor selecciona un canal');
        return;
    }
    
    try {
        const response = await fetch(`/api/guilds/{{ guild.id }}/game-roles/create-panel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ channel_id: channelId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', 'Panel creado correctamente en Discord');
        } else {
            showAlert('danger', 'Error al crear panel: ' + result.error);
        }
    } catch (error) {
        showAlert('danger', 'Error de conexi√≥n');
    }
}
</script>
{% endblock %}
