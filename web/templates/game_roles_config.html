{% extends "base.html" %}

{% block title %}Roles de Juegos - {{ guild.name }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="d-flex align-items-center mb-4">
        <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-outline-secondary me-3">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
        <h1 class="mb-0">
            <i class="bi bi-controller"></i> Roles de Juegos - {{ guild.name }}
        </h1>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-gear"></i> Configuraci√≥n</h5>
                </div>
                <div class="card-body">
                    <form id="gameRolesForm">
                        <div class="mb-3">
                            <label for="channelId" class="form-label">Canal para Panel de Roles</label>
                            <select class="form-select" id="channelId">
                                <option value="">Cargando canales...</option>
                            </select>
                            <div class="form-text" id="channelHelp">
                                Canal donde se enviar√° el panel de selecci√≥n de roles
                            </div>
                            <div id="manualChannelInput" style="display: none;" class="mt-2">
                                <label for="manualChannelId" class="form-label small">O ingresa el ID del canal manualmente:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="manualChannelId" 
                                           placeholder="ID del canal (ej: 1234567890)">
                                    <button class="btn btn-outline-secondary" type="button" id="useManualChannel">
                                        <i class="bi bi-check"></i> Usar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Guardar Canal
                        </button>
                    </form>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-joystick"></i> Roles Configurados</h5>
                </div>
                <div class="card-body">
                    <div id="gameRolesList" class="mb-3">
                        <p class="text-muted text-center py-3">Cargando roles...</p>
                    </div>

                    <hr>

                    <h6 class="mb-3">Agregar Nuevo Rol de Juego</h6>
                    <form id="addGameRoleForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="gameName" class="form-label">Nombre del Juego</label>
                                <input type="text" class="form-control" id="gameName" 
                                       placeholder="Ej: Valorant, Minecraft, etc." required 
                                       list="gamesList">
                                <datalist id="gamesList">
                                    <option value="Rexys">
                                    <option value="Lolsito">
                                    <option value="Pokemon">
                                    <option value="Valorant">
                                    <option value="Fortnite">
                                    <option value="Marvel Rivals">
                                    <option value="Battlefield">
                                    <option value="Palia">
                                    <option value="League of Legends">
                                    <option value="Minecraft">
                                    <option value="Counter-Strike">
                                    <option value="Overwatch">
                                    <option value="Apex Legends">
                                </datalist>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="gameRole" class="form-label">Rol</label>
                                <select class="form-select" id="gameRole" required>
                                    <option value="">Cargando roles...</option>
                                </select>
                            </div>
                        </div>
                        <div id="manualRoleInput" style="display: none;" class="mb-3">
                            <label for="manualRoleId" class="form-label small">O ingresa el ID del rol manualmente:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="manualRoleId" 
                                       placeholder="ID del rol (ej: 1234567890)">
                                <button class="btn btn-outline-secondary" type="button" id="useManualRole">
                                    <i class="bi bi-check"></i> Usar
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-plus-circle"></i> Agregar Rol
                        </button>
                    </form>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-send"></i> Crear Panel en Discord</h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">Una vez configurados los roles y el canal, crea el panel interactivo en Discord.</p>
                    <button class="btn btn-info w-100" id="createPanelBtn">
                        <i class="bi bi-send-fill"></i> Crear/Actualizar Panel en Discord
                    </button>
                    <div class="form-text mt-2">
                        O usa el comando <code>/setupgameroles</code> en Discord
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> ¬øC√≥mo funciona?</h6>
                </div>
                <div class="card-body">
                    <ol class="mb-0 small">
                        <li class="mb-2">Selecciona un canal donde aparecer√° el panel</li>
                        <li class="mb-2">Configura los roles para cada juego</li>
                        <li class="mb-2">Crea el panel en Discord</li>
                        <li class="mb-0">Los usuarios podr√°n seleccionar sus roles con botones</li>
                    </ol>
                </div>
            </div>

            <div class="card shadow-sm mb-3">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="bi bi-check-circle"></i> Caracter√≠sticas</h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0 small">
                        <li class="mb-2">‚ú® Botones permanentes (funcionan 24/7)</li>
                        <li class="mb-2">üéØ Click para agregar, click de nuevo para remover</li>
                        <li class="mb-2">üé® Dise√±o colorido y atractivo</li>
                        <li class="mb-0">üë• F√°cil de usar para los miembros</li>
                    </ul>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Consejos</h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0 small">
                        <li class="mb-2">üí° Crea roles espec√≠ficos para cada juego</li>
                        <li class="mb-2">üé® Usa colores diferentes para cada rol</li>
                        <li class="mb-2">üìç Coloca el panel en un canal visible</li>
                        <li class="mb-0">üîÑ Actualiza el panel cuando agregues nuevos juegos</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const guildId = '{{ guild.id }}';

// Cargar canales
async function loadChannels() {
    try {
        const response = await fetch(`/game-roles/api/${guildId}/channels`);
        const channels = await response.json();
        
        const select = document.getElementById('channelId');
        
        if (channels.length > 0) {
            select.innerHTML = '<option value="">Selecciona un canal</option>';
            channels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel.id;
                option.textContent = `# ${channel.name}`;
                select.appendChild(option);
            });
            const manualOption = document.createElement('option');
            manualOption.value = 'manual';
            manualOption.textContent = '‚öôÔ∏è Ingresar ID manualmente';
            select.appendChild(manualOption);
        } else {
            select.innerHTML = '<option value="">No se pudieron cargar canales</option>';
            const manualOption = document.createElement('option');
            manualOption.value = 'manual';
            manualOption.textContent = '‚öôÔ∏è Ingresar ID del canal';
            manualOption.selected = true;
            select.appendChild(manualOption);
            document.getElementById('manualChannelInput').style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading channels:', error);
    }
}

// Cargar roles
async function loadRoles() {
    try {
        const response = await fetch(`/game-roles/api/${guildId}/roles`);
        const roles = await response.json();
        
        const select = document.getElementById('gameRole');
        
        if (roles.length > 0) {
            select.innerHTML = '<option value="">Selecciona un rol</option>';
            roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id;
                option.textContent = role.name;
                select.appendChild(option);
            });
            const manualOption = document.createElement('option');
            manualOption.value = 'manual';
            manualOption.textContent = '‚öôÔ∏è Ingresar ID manualmente';
            select.appendChild(manualOption);
        } else {
            select.innerHTML = '<option value="">No se pudieron cargar roles</option>';
            const manualOption = document.createElement('option');
            manualOption.value = 'manual';
            manualOption.textContent = '‚öôÔ∏è Ingresar ID del rol';
            manualOption.selected = true;
            select.appendChild(manualOption);
            document.getElementById('manualRoleInput').style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading roles:', error);
    }
}

// Cargar configuraci√≥n
async function loadConfig() {
    try {
        const response = await fetch(`/game-roles/api/${guildId}/config`);
        const config = await response.json();
        
        if (config.channel_id) {
            document.getElementById('channelId').value = config.channel_id;
        }
        
        // Cargar lista de roles configurados
        const rolesList = document.getElementById('gameRolesList');
        const roles = config.roles || {};
        
        if (Object.keys(roles).length === 0) {
            rolesList.innerHTML = '<p class="text-muted text-center py-3">No hay roles configurados a√∫n</p>';
        } else {
            rolesList.innerHTML = '';
            for (const [gameName, roleId] of Object.entries(roles)) {
                const div = document.createElement('div');
                div.className = 'd-flex justify-content-between align-items-center mb-2 p-3 border rounded';
                div.innerHTML = `
                    <div>
                        <strong>üéÆ ${gameName}</strong>
                        <span class="text-muted mx-2">‚Üí</span>
                        <span class="badge bg-secondary">Rol ID: ${roleId}</span>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeGameRole('${gameName}')">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                `;
                rolesList.appendChild(div);
            }
        }
    } catch (error) {
        console.error('Error loading config:', error);
    }
}

// Guardar canal
document.getElementById('gameRolesForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const channelId = document.getElementById('channelId').value;
    
    if (!channelId || channelId === 'manual') {
        alert('Por favor selecciona un canal v√°lido');
        return;
    }
    
    try {
        const response = await fetch(`/game-roles/api/${guildId}/config`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ channel_id: channelId })
        });
        
        if (response.ok) {
            alert('Canal guardado correctamente');
        } else {
            alert('Error al guardar canal');
        }
    } catch (error) {
        console.error('Error saving config:', error);
        alert('Error al guardar configuraci√≥n');
    }
});

// Agregar rol de juego
document.getElementById('addGameRoleForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const gameName = document.getElementById('gameName').value.trim();
    let roleId = document.getElementById('gameRole').value;
    
    if (roleId === 'manual') {
        roleId = document.getElementById('manualRoleId').value.trim();
    }
    
    if (!gameName || !roleId) {
        alert('Por favor completa todos los campos');
        return;
    }
    
    try {
        const response = await fetch(`/game-roles/api/${guildId}/add-role`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ game_name: gameName, role_id: roleId })
        });
        
        if (response.ok) {
            alert('Rol agregado correctamente');
            document.getElementById('gameName').value = '';
            document.getElementById('gameRole').value = '';
            document.getElementById('manualRoleId').value = '';
            loadConfig();
        } else {
            alert('Error al agregar rol');
        }
    } catch (error) {
        console.error('Error adding role:', error);
        alert('Error al agregar rol');
    }
});

// Eliminar rol de juego
async function removeGameRole(gameName) {
    if (!confirm(`¬øEliminar el rol de ${gameName}?`)) return;
    
    try {
        const response = await fetch(`/game-roles/api/${guildId}/remove-role`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ game_name: gameName })
        });
        
        if (response.ok) {
            alert('Rol eliminado correctamente');
            loadConfig();
        } else {
            alert('Error al eliminar rol');
        }
    } catch (error) {
        console.error('Error removing role:', error);
        alert('Error al eliminar rol');
    }
}

// Crear panel
document.getElementById('createPanelBtn').addEventListener('click', async () => {
    try {
        const response = await fetch(`/game-roles/api/${guildId}/create-panel`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Panel creado correctamente en Discord');
        } else {
            alert(result.message || 'Error al crear panel');
        }
    } catch (error) {
        console.error('Error creating panel:', error);
        alert('Error al crear panel');
    }
});

// Manejar inputs manuales
document.getElementById('channelId').addEventListener('change', (e) => {
    document.getElementById('manualChannelInput').style.display = e.target.value === 'manual' ? 'block' : 'none';
});

document.getElementById('gameRole').addEventListener('change', (e) => {
    document.getElementById('manualRoleInput').style.display = e.target.value === 'manual' ? 'block' : 'none';
});

document.getElementById('useManualChannel').addEventListener('click', () => {
    const manualId = document.getElementById('manualChannelId').value.trim();
    if (manualId && /^\d+$/.test(manualId)) {
        const select = document.getElementById('channelId');
        const option = document.createElement('option');
        option.value = manualId;
        option.textContent = `# Canal (ID: ${manualId})`;
        option.selected = true;
        select.insertBefore(option, select.firstChild);
        document.getElementById('manualChannelInput').style.display = 'none';
    } else {
        alert('Por favor ingresa un ID v√°lido (solo n√∫meros)');
    }
});

document.getElementById('useManualRole').addEventListener('click', () => {
    const manualId = document.getElementById('manualRoleId').value.trim();
    if (manualId && /^\d+$/.test(manualId)) {
        const select = document.getElementById('gameRole');
        const option = document.createElement('option');
        option.value = manualId;
        option.textContent = `Rol (ID: ${manualId})`;
        option.selected = true;
        select.insertBefore(option, select.firstChild);
        document.getElementById('manualRoleInput').style.display = 'none';
    } else {
        alert('Por favor ingresa un ID v√°lido (solo n√∫meros)');
    }
});

// Cargar todo al iniciar
loadChannels();
loadRoles();
loadConfig();
</script>
{% endblock %}
