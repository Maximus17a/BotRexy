{% extends "base.html" %}

{% block title %}Configurar Bienvenida - {{ guild.name }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="d-flex align-items-center mb-4">
        <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-outline-secondary me-3">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
        <h1 class="mb-0">
            <i class="bi bi-hand-wave"></i> Configurar Bienvenida - {{ guild.name }}
        </h1>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-gear"></i> Configuración</h5>
                </div>
                <div class="card-body">
                    <form id="welcomeForm">
                        <div class="mb-3">
                            <label for="welcomeEnabled" class="form-label">Estado</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="welcomeEnabled" checked>
                                <label class="form-check-label" for="welcomeEnabled">
                                    Activar mensajes de bienvenida
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="channelId" class="form-label">Canal de Bienvenida</label>
                            <select class="form-select" id="channelId">
                                <option value="">Cargando canales...</option>
                            </select>
                            <div class="form-text" id="channelHelp">
                                Selecciona el canal donde se enviarán los mensajes de bienvenida.
                            </div>
                            <div id="manualChannelInput" style="display: none;" class="mt-2">
                                <label for="manualChannelId" class="form-label small">O ingresa el ID del canal manualmente:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="manualChannelId" 
                                           placeholder="ID del canal (ej: 1234567890)">
                                    <button class="btn btn-outline-secondary" type="button" id="useManualChannel">
                                        <i class="bi bi-check"></i> Usar
                                    </button>
                                </div>
                                <div class="form-text small">
                                    Para obtener el ID: Discord → Configuración → Avanzado → Modo Desarrollador → Clic derecho en canal → Copiar ID
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="welcomeMessage" class="form-label">Mensaje de Bienvenida</label>
                            <textarea class="form-control" id="welcomeMessage" rows="3" 
                                      placeholder="¡Bienvenido {user} a {server}!">¡Bienvenido {user} a {server}!</textarea>
                            <div class="form-text">
                                Variables disponibles: <code>{user}</code> <code>{server}</code> <code>{members}</code>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Imagen de Bienvenida</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="imageEnabled" checked>
                                <label class="form-check-label" for="imageEnabled">
                                    Incluir imagen personalizada
                                </label>
                            </div>
                        </div>

                        <div id="imageSettings">
                            <div class="mb-3">
                                <label for="backgroundImage" class="form-label">Imagen de Fondo</label>
                                <input type="file" class="form-control" id="backgroundImage" 
                                       accept="image/png,image/jpeg,image/jpg,image/gif,image/webp">
                                <div class="form-text">
                                    Sube una imagen personalizada para el fondo. Si no subes ninguna, se usará el color de fondo.
                                </div>
                                <div id="currentBackgroundPreview" class="mt-2" style="display: none;">
                                    <p class="mb-1"><strong>Imagen actual:</strong></p>
                                    <img id="currentBackgroundImg" src="" alt="Fondo actual" 
                                         style="max-width: 200px; height: auto; border-radius: 5px;">
                                    <button type="button" class="btn btn-sm btn-danger ms-2" id="removeBackgroundBtn">
                                        <i class="bi bi-trash"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="bgColor" class="form-label">Color de Fondo (alternativo)</label>
                                    <input type="color" class="form-control form-control-color" 
                                           id="bgColor" value="#7289da">
                                    <div class="form-text">Se usa si no hay imagen de fondo</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="textColor" class="form-label">Color de Texto</label>
                                    <input type="color" class="form-control form-control-color" 
                                           id="textColor" value="#ffffff">
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Guardar Cambios
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="previewBtn">
                                <i class="bi bi-eye"></i> Vista Previa
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-eye"></i> Vista Previa</h5>
                </div>
                <div class="card-body text-center" id="previewContainer">
                    <p class="text-muted">Haz clic en "Vista Previa" para ver cómo se verá la imagen de bienvenida.</p>
                    <img id="previewImage" src="" alt="Preview" class="img-fluid rounded" style="display: none;">
                </div>
            </div>

            <div class="card shadow-sm mt-3">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Ayuda</h5>
                </div>
                <div class="card-body">
                    <h6>Variables de Mensaje:</h6>
                    <ul class="small">
                        <li><code>{user}</code> - Mención del usuario</li>
                        <li><code>{server}</code> - Nombre del servidor</li>
                        <li><code>{members}</code> - Cantidad de miembros</li>
                    </ul>
                    <hr>
                    <h6>Personalización de Imagen:</h6>
                    <p class="small mb-0">
                        Puedes personalizar los colores de fondo y texto de la imagen de bienvenida 
                        para que coincidan con el tema de tu servidor.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const guildId = '{{ guild.id }}';

// Cargar canales del servidor
async function loadChannels() {
    try {
        const response = await fetch(`/welcome/api/${guildId}/channels`);
        const channels = await response.json();
        
        const select = document.getElementById('channelId');
        
        if (channels.length > 0) {
            // Hay canales disponibles desde la API
            select.innerHTML = '<option value="">Selecciona un canal</option>';
            
            channels.forEach(channel => {
                if (channel.type === 0 || channel.type === 5) { // Text o announcement channels
                    const option = document.createElement('option');
                    option.value = channel.id;
                    option.textContent = `# ${channel.name}`;
                    select.appendChild(option);
                }
            });
            
            // Agregar opción manual al final
            const manualOption = document.createElement('option');
            manualOption.value = 'manual';
            manualOption.textContent = '⚙️ Ingresar ID manualmente';
            select.appendChild(manualOption);
        } else {
            // No hay canales, mostrar opción manual
            select.innerHTML = '<option value="">No se pudieron cargar los canales</option>';
            const manualOption = document.createElement('option');
            manualOption.value = 'manual';
            manualOption.textContent = '⚙️ Ingresar ID del canal';
            manualOption.selected = true;
            select.appendChild(manualOption);
            document.getElementById('manualChannelInput').style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading channels:', error);
        const select = document.getElementById('channelId');
        select.innerHTML = '<option value="">Error al cargar canales</option>';
        const manualOption = document.createElement('option');
        manualOption.value = 'manual';
        manualOption.textContent = '⚙️ Ingresar ID del canal';
        manualOption.selected = true;
        select.appendChild(manualOption);
        document.getElementById('manualChannelInput').style.display = 'block';
    }
}

// Manejar cambio de selección de canal
document.addEventListener('DOMContentLoaded', () => {
    const channelSelect = document.getElementById('channelId');
    const manualInput = document.getElementById('manualChannelInput');
    
    channelSelect.addEventListener('change', (e) => {
        if (e.target.value === 'manual') {
            manualInput.style.display = 'block';
        } else {
            manualInput.style.display = 'none';
        }
    });
    
    // Botón para usar ID manual
    document.getElementById('useManualChannel').addEventListener('click', () => {
        const manualId = document.getElementById('manualChannelId').value.trim();
        if (manualId && /^\d+$/.test(manualId)) {
            const select = document.getElementById('channelId');
            
            // Verificar si ya existe
            let existingOption = Array.from(select.options).find(opt => opt.value === manualId);
            
            if (!existingOption) {
                // Crear nueva opción
                const option = document.createElement('option');
                option.value = manualId;
                option.textContent = `# Canal (ID: ${manualId})`;
                // Insertar antes de la opción "manual"
                const manualOption = Array.from(select.options).find(opt => opt.value === 'manual');
                if (manualOption) {
                    select.insertBefore(option, manualOption);
                } else {
                    select.appendChild(option);
                }
            }
            
            // Seleccionar el canal
            select.value = manualId;
            manualInput.style.display = 'none';
            document.getElementById('manualChannelId').value = '';
        } else {
            alert('Por favor ingresa un ID de canal válido (solo números)');
        }
    });
});

// Cargar configuración actual
async function loadConfig() {
    try {
        const response = await fetch(`/welcome/api/${guildId}/config`);
        const config = await response.json();
        
        document.getElementById('welcomeEnabled').checked = config.enabled || false;
        document.getElementById('channelId').value = config.channel_id || '';
        document.getElementById('welcomeMessage').value = config.message || '¡Bienvenido {user} a {server}!';
        document.getElementById('imageEnabled').checked = config.image_enabled !== false;
        document.getElementById('bgColor').value = config.image_background || '#7289da';
        document.getElementById('textColor').value = config.image_text_color || '#ffffff';
        
        // Mostrar imagen de fondo actual si existe
        if (config.background_image_url) {
            const preview = document.getElementById('currentBackgroundPreview');
            const img = document.getElementById('currentBackgroundImg');
            img.src = config.background_image_url;
            preview.style.display = 'block';
            window.currentBackgroundUrl = config.background_image_url;
        }
    } catch (error) {
        console.error('Error loading config:', error);
    }
}

// Guardar configuración
document.getElementById('welcomeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Primero subir imagen si hay una nueva
    const fileInput = document.getElementById('backgroundImage');
    if (fileInput.files.length > 0) {
        const formData = new FormData();
        formData.append('background_image', fileInput.files[0]);
        
        try {
            const uploadResponse = await fetch(`/welcome/api/${guildId}/upload-background`, {
                method: 'POST',
                body: formData
            });
            
            if (uploadResponse.ok) {
                const result = await uploadResponse.json();
                window.currentBackgroundUrl = result.image_url;
            } else {
                alert('Error al subir la imagen de fondo');
                return;
            }
        } catch (error) {
            console.error('Error uploading background:', error);
            alert('Error al subir la imagen de fondo');
            return;
        }
    }
    
    const config = {
        enabled: document.getElementById('welcomeEnabled').checked,
        channel_id: document.getElementById('channelId').value,
        message: document.getElementById('welcomeMessage').value,
        image_enabled: document.getElementById('imageEnabled').checked,
        image_background: document.getElementById('bgColor').value,
        image_text_color: document.getElementById('textColor').value
    };
    
    try {
        const response = await fetch(`/welcome/api/${guildId}/config`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        });
        
        if (response.ok) {
            alert('Configuración guardada correctamente');
            loadConfig(); // Recargar para mostrar la nueva imagen
        } else {
            alert('Error al guardar configuración');
        }
    } catch (error) {
        console.error('Error saving config:', error);
        alert('Error al guardar configuración');
    }
});

// Vista previa
document.getElementById('previewBtn').addEventListener('click', async () => {
    const data = {
        user_name: '{{ user.username }}',
        bg_color: document.getElementById('bgColor').value,
        text_color: document.getElementById('textColor').value,
        background_image_url: window.currentBackgroundUrl || null
    };
    
    try {
        const response = await fetch(`/welcome/api/${guildId}/preview`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const img = document.getElementById('previewImage');
            img.src = url;
            img.style.display = 'block';
            document.querySelector('#previewContainer p').style.display = 'none';
        } else {
            alert('Error al generar vista previa');
        }
    } catch (error) {
        console.error('Error generating preview:', error);
        alert('Error al generar vista previa');
    }
});

// Toggle image settings
document.getElementById('imageEnabled').addEventListener('change', (e) => {
    document.getElementById('imageSettings').style.display = e.target.checked ? 'block' : 'none';
});

// Eliminar imagen de fondo
document.getElementById('removeBackgroundBtn').addEventListener('click', async () => {
    if (!confirm('¿Estás seguro de que quieres eliminar la imagen de fondo?')) {
        return;
    }
    
    try {
        const response = await fetch(`/welcome/api/${guildId}/remove-background`, {
            method: 'POST'
        });
        
        if (response.ok) {
            window.currentBackgroundUrl = null;
            document.getElementById('currentBackgroundPreview').style.display = 'none';
            document.getElementById('backgroundImage').value = '';
            alert('Imagen de fondo eliminada correctamente');
        } else {
            alert('Error al eliminar la imagen de fondo');
        }
    } catch (error) {
        console.error('Error removing background:', error);
        alert('Error al eliminar la imagen de fondo');
    }
});

// Cargar canales y configuración al iniciar
loadChannels();
loadConfig();
</script>
{% endblock %}
